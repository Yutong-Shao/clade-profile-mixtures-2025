---
title: "PBT_CvMtest"
author: "u7627793 Yutong Shao"
date: "2025-07-21"
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(ggridges)
library(patchwork)

# Step 1: 读取 csv
cvm_results <- read_csv("D:/8701/data_tidy/Cyanobacteria_617/cvm_cyano.csv")
cvm_results <- cvm_results %>%
  mutate(
    # 替换下划线为短横线
    model = gsub("_", "-", model)
  ) %>%
  mutate(
    group = case_when(
      grepl("C10|C60", model) & grepl("PMSF", model) ~ "CXX-PMSF",
      grepl("UDM", model) & grepl("PMSF", model) ~ "UDM-PMSF",
      grepl("MEOW", model) & grepl("PMSF", model) ~ "MEOW-PMSF",
      grepl("C60", model) & !grepl("PMSF", model) ~ "non-PMSF",
      TRUE ~ NA_character_
    ),
    
    weights = case_when(
      grepl("fix", model, ignore.case = TRUE) ~ "fix",
      grepl("opt", model, ignore.case = TRUE) ~ "opt",
      TRUE ~ "default"
    ),
    
    exchangeability = case_when(
      grepl("Poisson", model) ~ "Poisson",
      grepl("LG", model) ~ "LG",
      grepl("GTR20", model) ~ "GTR20",
      TRUE ~ NA_character_
    ),
    
    label_raw = model %>%
      gsub("fix", "", .) %>%
      gsub("opt", "", .)
  ) %>%
  mutate(
    sort_key = case_when(
      grepl("C10", model) ~ 1,
      grepl("C60", model) ~ 2,
      grepl("UDM8", model) ~ 3,
      grepl("UDM64", model) ~ 4,
      grepl("UDM128", model) ~ 5,
      grepl("MEOW10", model) ~ 6,
      grepl("MEOW60", model) ~ 7,
      grepl("MEOW120", model) ~ 8,
      TRUE ~ 99
    )
  ) %>%
  arrange(
    factor(group, levels = c("CXX-PMSF", "UDM-PMSF", "MEOW-PMSF", "non-PMSF")),
    exchangeability, sort_key, label_raw
  )

# 设置label levels
cvm_results <- cvm_results %>%
  mutate(label = factor(label_raw, levels = rev(unique(label_raw))))

# Step 3: 准备 label_positions
labels <- levels(cvm_results$label)
label_positions <- data.frame(
  label = labels,
  ypos  = seq_along(labels)
)

# Step 4: ridge 分布图
p_ridges <- ggplot(cvm_results, aes(x = W2_statistic, y = label, fill = weights)) +
  geom_density_ridges(
    scale = 1.3, rel_min_height = 0, alpha = 0.7,
    color = "black", linewidth = 0.37,
    panel_scaling = FALSE, position = "identity"
  ) +
  geom_segment(
    data = label_positions,
    aes(x = min(cvm_results$W2_statistic), xend = max(cvm_results$W2_statistic),
        y = ypos, yend = ypos),
    inherit.aes = FALSE, color = "black", linewidth = 0.4
  ) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_discrete(expand = expansion(add = c(0,0))) +
  labs(x = expression(W^2 ~ "(Cramér-von Mises Statistic)")) +
  scale_fill_manual(values = c("fix" = "#9AC4DB", "opt" = "#CB8D8B", "default" = "grey70")) +
  theme_void() +
  theme(
    axis.title.x = element_text(size = 9),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_line(color = "black", size = 0.5),
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.ticks.x = element_line(color = "black", size = 0.5),
    axis.ticks.y.left = element_line(color = "black", size = 0.5),
    axis.ticks.length = unit(0.1, "cm"),
    panel.grid.major.x = element_blank(),
    legend.position = "top",
    legend.margin = margin(b = 5),
    legend.title = element_blank(),
    legend.text = element_text(size = 7)
  )

# Step 5: Labels plot
label_background <- cvm_results %>%
  select(label, group) %>%
  distinct() %>%
  mutate(ypos = seq(from = 1, by = 2, length.out = n()))

p_labels <- ggplot(label_background, aes(x = 2, y = ypos, fill = group)) +
  geom_tile(width = 3.7, height = 2.0) +
  scale_fill_manual(values = c(
    "CXX-PMSF" = "#E9CDDF",
    "UDM-PMSF" = "#C8BFD9",
    "MEOW-PMSF"= "#D0E0EF",
    "non-PMSF" = "#B6C9C0"
  )) +
  geom_text(aes(label = label, y = ypos),
            hjust = 1, size = 2.5, nudge_x = 1.8) +
  scale_y_reverse(expand = expansion(add = c(-1,1))) +
  theme_void() +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off", xlim = c(0.3,3.58)) +
  theme(plot.margin = margin(0.5,0.14,0,-0))

# Step 6: 拼接
final_plot <- p_labels + plot_spacer() + p_ridges + 
  plot_layout(widths = c(0.8, 0.000001, 4))

print(final_plot)

ggsave("D:/8701/clade-profile-mixtures-2025/script/PBT/Cyano_4_cvm.png", plot = final_plot, width = 10, height = 6, dpi = 900)
```

